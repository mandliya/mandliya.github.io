name: Convert Notebook to Draft

on:
  push:
    paths:
      - '**/*.ipynb'
      - '**/*.py'
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      notebook_source:
        description: 'Notebook source (local path, GitHub repo, or URL)'
        required: true
        default: '_notebooks/*.ipynb'
        type: string
      output_name:
        description: 'Custom output name (optional)'
        required: false
        type: string
      auto_publish:
        description: 'Automatically publish the draft'
        required: false
        default: false
        type: boolean

jobs:
  convert-notebook:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install nbformat nbconvert PyYAML

    - name: Find notebooks to convert
      id: find-notebooks
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Use the input source
          NOTEBOOK_SOURCE="${{ github.event.inputs.notebook_source }}"

          if [[ "$NOTEBOOK_SOURCE" == *"*"* ]]; then
            # Handle wildcard patterns for local files
            NOTEBOOKS=$(find . -path "$NOTEBOOK_SOURCE" -name "*.ipynb" 2>/dev/null || echo "")
          else
            # Single source (could be repo, URL, or file)
            NOTEBOOKS="$NOTEBOOK_SOURCE"
          fi
        else
          # Find all .ipynb files that were changed in the push
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            NOTEBOOKS=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '\.ipynb$' || echo "")
          else
            # First push or no before commit, check all notebooks
            NOTEBOOKS=$(find . -name "*.ipynb" -not -path "./.git/*" | head -5 || echo "")
          fi
        fi

        if [ -z "$NOTEBOOKS" ]; then
          echo "No notebooks found to convert"
          echo "notebooks=" >> $GITHUB_OUTPUT
        else
          echo "notebooks<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTEBOOKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found notebooks/sources: $NOTEBOOKS"
        fi

    - name: Convert notebooks to drafts
      if: steps.find-notebooks.outputs.notebooks != ''
      run: |
        # Process each notebook/source
        echo "${{ steps.find-notebooks.outputs.notebooks }}" | while IFS= read -r notebook_source; do
          if [ -n "$notebook_source" ]; then
            echo "Converting: $notebook_source"

            if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.output_name }}" ]; then
              python3 notebook_to_draft.py "$notebook_source" --output "${{ github.event.inputs.output_name }}" --blog-root .
            else
              python3 notebook_to_draft.py "$notebook_source" --blog-root .
            fi

            echo "‚úÖ Converted: $notebook_source"
          fi
        done

    - name: Move drafts to posts if auto-publish is enabled
      if: github.event.inputs.auto_publish == 'true'
      run: |
        if [ -d "_drafts" ] && [ "$(ls -A _drafts)" ]; then
          echo "Auto-publishing drafts..."
          for draft in _drafts/*.md; do
            if [ -f "$draft" ]; then
              filename=$(basename "$draft")
              # Add date prefix if not present
              if [[ ! "$filename" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}- ]]; then
                dated_filename="$(date +%Y-%m-%d)-$filename"
              else
                dated_filename="$filename"
              fi

              mv "$draft" "_posts/$dated_filename"
              echo "Published: $dated_filename"
            fi
          done
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add all changes
        git add _drafts/ _posts/ assets/img/ || true

        # Check if there are any changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          if [ "${{ github.event.inputs.auto_publish }}" = "true" ]; then
            git commit -m "Auto-convert and publish notebooks [skip ci]"
          else
            git commit -m "Auto-convert notebooks to drafts [skip ci]"
          fi
          git push
        fi

    - name: Create issue for review
      if: success() && steps.find-notebooks.outputs.notebooks != '' && github.event.inputs.auto_publish != 'true'
      run: |
        # Create an issue to notify about the new draft
        NOTEBOOKS="${{ steps.find-notebooks.outputs.notebooks }}"

        if [ -n "$NOTEBOOKS" ]; then
          # Count the number of notebooks processed
          NOTEBOOK_COUNT=$(echo "$NOTEBOOKS" | wc -l)

          if [ "$NOTEBOOK_COUNT" -eq 1 ]; then
            TITLE="New draft post created from notebook"
          else
            TITLE="New draft posts created from $NOTEBOOK_COUNT notebooks"
          fi

          BODY="## üìì Notebooks converted to drafts:

          The following notebook sources have been automatically converted to draft posts:

          \`\`\`
          $NOTEBOOKS
          \`\`\`

          ### üìã Next steps:
          1. üìñ Review the drafts in the \`_drafts\` directory
          2. üñºÔ∏è Add cover images if needed (\`/assets/img/[slug]/cover.png\`)
          3. ‚úèÔ∏è Edit front matter and content as needed
          4. üöÄ Publish using your workflow or move to \`_posts\` directory

          ### üîó Quick actions:
          - **Preview locally**: \`bundle exec jekyll serve --drafts\`
          - **Publish draft**: Move from \`_drafts/\` to \`_posts/\` with date prefix

          ---
          *ü§ñ This issue was automatically created by the notebook converter workflow.*"

          gh issue create \
            --title "$TITLE" \
            --body "$BODY" \
            --label "draft" \
            --label "notebook" \
            --label "automated"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on commit if auto-published
      if: success() && github.event.inputs.auto_publish == 'true' && steps.find-notebooks.outputs.notebooks != ''
      run: |
        echo "üöÄ Notebooks have been automatically converted and published!"
        echo "Check your blog to see the new posts."
